---
title: Linux服务器CPU因挖矿恶意程序导致爆满的经历
date: 2021-09-07 17:42:43
tags: 
- cpu爆满
- 挖矿
---

# 起因

今天，突然间收到阿里云发来的一封安全告警处理的邮件，然后登录到阿里云工作台，在安全告警处理页面看到有很多紧急告警项，此时意识到自己的云服务器被攻击了，阿里云识别出的是植入挖矿程序，这种挖矿程序会占用服务器99%的CPU，严重影响正常的运行。

<img src="攻击.png" style="zoom:75%;" />

<img src="挖矿.png" style="zoom:75%;" />

<br>

继续往下看，可以看到攻击入口是通过暴力破解了服务器子用户git的登陆密码进到服务器里的，也怪自己当时子用户密码设置的比较随意

<img src="密码.png" style="zoom:75%;" />

# 解决办法

从分析中看到进程命令行是./tti，然后登陆到服务器里面，运行top命令，看到第一行正是因为git用户的tti命令使得CPU占满

<img src="top-cpu.png" style="zoom:75%;" />

<br>

看到这，第一反应，是直接执行`killall tti`，杀掉这个进程，但是过了一会发现CPU又爆满了，emmmm，这可能是一个定时任务，又运行ps -ef | grep tti搜索tti命令的进程，找到这条进程，可以看到`tti start`命令是在/var/tmp/.wintsk目录下面，此时再到/var/tmp/目录下面，执行`ls -al`，找到.wintsk文件夹，再强制删除`rm -rf .wintsk`，最后将进程杀掉`killall tti`，这样挖矿程序就彻底移除掉了。

> 注意：在/var/tmp/目录下面，执行`ls -al`时要加上-al参数，因为.wintsk文件夹是隐藏的，（藏得很深）

<img src="ps命令.png" style="zoom:75%;" />

<br>

<img src="隐藏的目录.png" style="zoom:75%;" />

<br>

> 你也可以通过`crontab -l -u git`命令根据指定用户查询所有定时任务，来找到挖矿程序运行目录

<img src="定时任务.png" />

# 修改密码

在处理完挖矿程序后，千万不要忘记把原来子用户git的弱密码修改一下，如果不改的话，下次别人还会通过暴力破解密码来进入到你的服务器里。修改子用户密码可以通过`passwd git`，也就是passwd命令加上你的子用户名

<img src="修改密码.png" style="zoom:75%;" />

> 注意：linux提醒你密码设置的太简单，所以密码尽可能设置复杂一点，增加暴力破解的难度



# 结语

以上便是这次处理挖矿程序的经历，记录下来方便以后再次遇见类似问题，也给自己提个醒，毕竟服务器被入侵是很严重的问题，尤其是公司里生产环境服务器。